#!/usr/bin/env node

/**
 * Express Backend Starter CLI
 * Main entry point for the CLI tool
 */

import { Command } from 'commander';
import chalk from 'chalk';
import { getUserInput } from '../src/prompts.js';
import { installDependencies } from '../src/installers.js';
import { generateProject } from '../src/generators.js';
import ora from 'ora';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs-extra';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Read package.json for version
const packageJson = JSON.parse(
  await fs.readFile(path.join(__dirname, '../package.json'), 'utf-8')
);

const program = new Command();

program
  .name('express-backend-starter')
  .description('Scaffold a production-ready Express.js/Node.js backend project')
  .version(packageJson.version)
  .action(async () => {
    console.log(chalk.cyan.bold('\nüöÄ Welcome to Express Backend Starter CLI\n'));
    console.log(chalk.gray('Let\'s scaffold your backend project...\n'));

    try {
      // Step 1: Get user input through interactive prompts
      const spinner = ora('Preparing questions...').start();
      spinner.succeed('Ready!');

      const answers = await getUserInput();

      // Step 2: Create project directory
      const projectPath = path.join(process.cwd(), answers.projectName);
      
      const creatingSpinner = ora('Creating project directory...').start();
      
      if (await fs.pathExists(projectPath)) {
        creatingSpinner.fail(chalk.red(`Directory "${answers.projectName}" already exists!`));
        process.exit(1);
      }

      await fs.ensureDir(projectPath);
      creatingSpinner.succeed(chalk.green('Project directory created'));

      // Step 3: Initialize npm project
      const initSpinner = ora('Initializing npm project...').start();
      await fs.writeJSON(path.join(projectPath, 'package.json'), {
        name: answers.projectName,
        version: '1.0.0',
        description: 'Backend project generated by Express Backend Starter CLI',
        main: 'src/app.js',
        type: 'module',
        scripts: {
          dev: 'nodemon src/app.js',
          start: 'node src/app.js'
        },
        keywords: [],
        author: '',
        license: 'ISC'
      }, { spaces: 2 });
      initSpinner.succeed(chalk.green('npm project initialized'));

      // Step 4: Install dependencies
      await installDependencies(projectPath, answers);

      // Step 5: Generate project structure and files
      await generateProject(projectPath, answers);

      // Success message
      console.log(chalk.green.bold('\n‚úÖ Project created successfully!\n'));
      console.log(chalk.cyan('Next steps:'));
      console.log(chalk.white(`  cd ${answers.projectName}`));
      console.log(chalk.white('  npm run dev\n'));
      console.log(chalk.gray('Happy coding! üéâ\n'));

    } catch (error) {
      console.error(chalk.red.bold('\n‚ùå Error:'), error.message);
      process.exit(1);
    }
  });

program.parse(process.argv);
